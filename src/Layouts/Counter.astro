---
import Layout from "./Layout.astro";
import { calcTimeLeft } from "../utils/calcTimeLeft";

const { date, meta, content } = Astro.props;

const targetIso = date.targetIso;
const initial = calcTimeLeft(targetIso);

// Fecha en formato legible
const toDate = new Date(targetIso);
const day = toDate.getUTCDate();
const month = toDate.toLocaleString("es-ES", { month: "long" });
const year = toDate.getUTCFullYear();
const daysLeft = initial.days;

const pageTitle = meta.pageTitle;
const description = meta.description;
const keywords = meta.keywords;
const url = meta.url;
const image = meta.image;

// Schema.org structured data URLs
const canonicalURL = new URL(url);
const siteURL = new URL("/", canonicalURL);
const webSiteSchema = new URL("/#/schema/WebSite", canonicalURL);
const organizationSchema = new URL("/#/schema/Organization", canonicalURL);

// Structured data
const structuredData = {
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "WebSite",
            "@id": webSiteSchema.toString(),
            name: "Faltapoco.com",
            description:
                "Contadores en tiempo real para eventos importantes. DescubrÃ­ cuÃ¡nto falta para el Mundial, Navidad, AÃ±o Nuevo y mÃ¡s.",
            url: siteURL.toString(),
            inLanguage: "es",
            publisher: {
                "@type": "Organization",
                "@id": organizationSchema.toString(),
                name: "Faltapoco",
                url: siteURL.toString(),
            },
        },
        {
            "@type": "WebPage",
            "@id": canonicalURL.toString(),
            url: canonicalURL.toString(),
            name: pageTitle,
            headline: pageTitle,
            description: description,
            image: image,
            inLanguage: "es",
            isPartOf: {
                "@id": webSiteSchema.toString(),
            },
            publisher: {
                "@type": "Organization",
                "@id": organizationSchema.toString(),
            },
        },
    ],
};
---

<Layout title={pageTitle}>
    <Fragment slot="head">
        <!-- Meta SEO -->
        <meta name="description" content={description} />
        <meta name="keywords" content={keywords} />
        <link rel="canonical" href={url} />

        <!-- Open Graph -->
        <meta property="og:title" content={pageTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content="website" />
        <meta property="og:url" content={url} />
        <meta property="og:image" content={image} />
        <meta property="og:locale" content="es_ES" />

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={pageTitle} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={image} />

        <!-- Schema.org (JSON-LD) -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify(structuredData)}
        />
    </Fragment>
    <main
        class="flex flex-col items-center justify-center flex-grow px-4 py-8 space-y-12 text-center md:gap-16"
    >
        <div class="flex flex-col items-center w-full space-y-4">
            <h1 class="text-4xl sm:text-5xl md:text-7xl font-extrabold mb-2">
                Â¿CuÃ¡nto tiempo falta para {content.connector}
                <span
                    class="bg-gradient-to-r from-[#0B5FFF] via-gray-400 to-[#0B5FFF] bg-clip-text text-transparent animate-gradient"
                    style="display: inline-block;"
                >
                    {content.title}
                </span>?
            </h1>
        </div>
        <style>
            @keyframes gradient-move {
                0% {
                    background-position: 0% 50%;
                }
                50% {
                    background-position: 100% 50%;
                }
                100% {
                    background-position: 0% 50%;
                }
            }
            .animate-gradient {
                background-size: 200% 200%;
                animation: gradient-move 4s ease-in-out infinite;
            }
        </style>
        <div class="max-w-5xl w-full space-y-6 text-center mx-auto">
            <div
                class="p-4 sm:p-8 rounded-lg shadow text-center mx-auto bg-white"
            >
                <div
                    class="text-lg sm:text-xl md:text-2xl text-[#FFDD00] font-semibold"
                >
                    {content.whatWhen} dÃ­a {day} de {month} de {year}.
                </div>
                <div
                    class="mt-4 sm:mt-4 text-4xl sm:text-6xl md:text-8xl text-[#0B5FFF] font-mono"
                    data-countdown
                    data-target={targetIso}
                    aria-live="polite"
                >
                    {initial.days}d {String(initial.hours).padStart(2, "0")}h {
                        String(initial.minutes).padStart(2, "0")
                    }m {String(initial.seconds).padStart(2, "0")}s
                </div>
                <div class="mt-4 text-base sm:text-lg text-gray-600">
                    Faltan {daysLeft} dÃ­as {content.timeLeft}.
                </div>
            </div>
            <div
                class="bg-gray-50 border border-gray-200 rounded-lg p-4 mt-4 shadow-sm"
                aria-label="InformaciÃ³n adicional sobre el evento"
            >
                {
                    content.info &&
                        content.info.map((item: string) => (
                            <p class="mt-2 text-base sm:text-lg text-gray-700 leading-relaxed">
                                {item}
                            </p>
                        ))
                }
            </div>
        </div>

        <script type="module" src="/js/countdown.js"></script>
        <script type="module">
            import { initCountdown } from "/js/countdown.js";
            // inicializa todos los [data-countdown]
            initCountdown();
        </script>
    </main>
    <!-- API Offering Section -->
    <section
        class="w-full max-w-2xl md:max-w-3xl mx-auto mt-8 p-3 sm:p-4 md:p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl shadow border border-gray-200 box-border"
        style="box-sizing: border-box;"
    >
        <h2
            class="text-2xl md:text-3xl font-bold text-center mb-3 text-gray-800"
        >
            ðŸš€ API Gratuita de Faltapoco
        </h2>
        <p class="text-center text-gray-600 mb-4 md:mb-6 text-base md:text-lg">
            Integra contadores de tiempo real en tu sitio web de forma gratuita.
        </p>

        <!-- Tabs -->
        <div class="flex flex-wrap justify-center gap-2 sm:gap-3 mb-6">
            <button
                id="tab-iframe"
                class="tab-button px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all bg-[#0B5FFF] text-white text-xs sm:text-sm md:text-base min-w-[90px]"
                onclick="switchApiTab('iframe', event)"
            >
                ðŸ“¦ iFrame
            </button>
            <button
                id="tab-fetch"
                class="tab-button px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all bg-gray-300 text-gray-700 hover:bg-gray-400 text-xs sm:text-sm md:text-base min-w-[90px]"
                onclick="switchApiTab('fetch', event)"
            >
                ðŸ”Œ Fetch API
            </button>
        </div>

        <!-- iFrame Embed Box -->
        <div
            id="api-iframe-box"
            class="bg-white rounded-lg p-4 md:p-5 shadow-sm w-full box-border mb-6"
            style="box-sizing: border-box;"
        >
            <h3 class="text-lg md:text-xl font-semibold mb-2 text-gray-700">
                ðŸ“¦ iFrame Embed
            </h3>
            <p class="text-gray-600 mb-3 text-sm md:text-base">
                CopiÃ¡ y pegÃ¡ este cÃ³digo en tu HTML para mostrar el contador
                directamente:
            </p>
            <div class="relative w-full mb-4">
                <pre
                    class="bg-gray-900 text-green-400 p-3 pr-8 md:pr-12 rounded-lg overflow-x-auto text-xs md:text-sm w-full box-border"
                    style="box-sizing: border-box; max-width: 100%;"><code id="iframe-code-new">&lt;iframe 
    src="https://faltapoco.com/api/embed/{meta.slug}" 
    width="100%" 
    height="250" 
    frameborder="0"
    style="border-radius: 8px;"
&gt;&lt;/iframe&gt;</code></pre>
                <button
                    onclick="copyCode('iframe-code-new', event)"
                    class="absolute top-2 right-2 bg-[#0B5FFF] hover:bg-blue-700 text-white px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg text-xs md:text-sm font-semibold transition-all shadow-sm min-w-[70px]"
                    style="box-sizing: border-box;"
                >
                    ðŸ“‹ Copiar
                </button>
            </div>
            <div class="mt-4 md:mt-6">
                <h4
                    class="font-semibold text-gray-700 mb-2 text-base md:text-lg"
                >
                    Vista previa:
                </h4>
                <div
                    class="border border-gray-300 rounded-lg overflow-hidden bg-white w-full box-border"
                    style="box-sizing: border-box;"
                >
                    <div
                        class="p-4 md:p-6 text-center w-full max-w-xs sm:max-w-md md:max-w-lg mx-auto box-border"
                        style="box-sizing: border-box;"
                    >
                        <div
                            class="text-[#FFDD00] font-semibold mb-3 text-base md:text-xl"
                        >
                            {content.timeLeft}
                        </div>
                        <div
                            class="text-[#0B5FFF] font-bold font-mono my-3 text-2xl sm:text-3xl md:text-4xl"
                        >
                            {initial.days}d {
                                String(initial.hours).padStart(2, "0")
                            }h {String(initial.minutes).padStart(2, "0")}m {
                                String(initial.seconds).padStart(2, "0")
                            }s
                        </div>
                        <div class="text-gray-500 text-xs md:text-base mt-2">
                            {content.info?.[0] || ""}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fetch Usage Box -->
        <div
            id="api-fetch-box"
            class="bg-white rounded-lg p-4 md:p-5 shadow-sm w-full box-border mb-6 hidden"
            style="box-sizing: border-box;"
        >
            <h3 class="text-lg md:text-xl font-semibold mb-2 text-gray-700">
                ðŸ”Œ Fetch API
            </h3>
            <p class="text-gray-600 mb-3 text-sm md:text-base">
                ObtenÃ© los datos del contador en formato JSON para
                personalizarlo:
            </p>
            <div class="relative w-full mb-4">
                <pre
                    class="bg-gray-900 text-green-400 p-3 pr-8 md:pr-12 rounded-lg overflow-x-auto text-xs md:text-sm w-full box-border"
                    style="box-sizing: border-box; max-width: 100%;"><code id="fetch-code">fetch("https://faltapoco.com/api/countdown/{meta.slug}")
  .then(r => r.json())
  .then(data => console.log(data));</code></pre>
                <button
                    onclick="copyCode('fetch-code', event)"
                    class="absolute top-2 right-2 bg-[#0B5FFF] hover:bg-blue-700 text-white px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg text-xs md:text-sm font-semibold transition-all shadow-sm min-w-[70px]"
                    style="box-sizing: border-box;"
                >
                    ðŸ“‹ Copiar
                </button>
            </div>
            <div
                class="bg-gray-50 p-3 md:p-4 rounded-lg w-full box-border"
                style="box-sizing: border-box;"
            >
                <h4
                    class="font-semibold text-gray-700 mb-2 text-base md:text-lg"
                >
                    Respuesta JSON de ejemplo:
                </h4>
                <pre
                    class="bg-gray-900 text-green-400 p-2 md:p-3 rounded text-xs overflow-x-auto w-full box-border"
                    style="box-sizing: border-box; max-width: 100%;"><code>{`{
  "slug": "${meta.slug}",
  "title": "${content.title}",
  "targetDate": "${targetIso}",
  "timeLeft": {
    "days": ${initial.days},
    "hours": ${initial.hours},
    "minutes": ${initial.minutes},
    "seconds": ${initial.seconds}
  },
  "description": "${content.info?.[0] || ''}",
  "url": "${url}"
}`}</code></pre>
            </div>
        </div>

        <!-- Link to Documentation -->
        <div class="text-center">
            <a
                href="https://faltapoco.com/api-docs"
                class="inline-block bg-[#0B5FFF] hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all shadow-sm"
            >
                ðŸ“– Ver DocumentaciÃ³n Completa
            </a>
        </div>

        <script is:inline>
            function switchApiTab(tab, event) {
                const iframeBtn = document.getElementById("tab-iframe");
                const fetchBtn = document.getElementById("tab-fetch");
                const iframeBox = document.getElementById("api-iframe-box");
                const fetchBox = document.getElementById("api-fetch-box");

                const activeClass =
                    "tab-button px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all bg-[#0B5FFF] text-white text-xs sm:text-sm md:text-base min-w-[90px]";
                const inactiveClass =
                    "tab-button px-3 py-2 sm:px-4 rounded-lg font-semibold transition-all bg-gray-300 text-gray-700 hover:bg-gray-400 text-xs sm:text-sm md:text-base min-w-[90px]";

                if (tab === "iframe") {
                    iframeBtn.className = activeClass;
                    fetchBtn.className = inactiveClass;
                    iframeBox.classList.remove("hidden");
                    fetchBox.classList.add("hidden");
                } else {
                    fetchBtn.className = activeClass;
                    iframeBtn.className = inactiveClass;
                    fetchBox.classList.remove("hidden");
                    iframeBox.classList.add("hidden");
                }
            }

            function copyCode(elementId, event) {
                const code = document.getElementById(elementId).textContent;
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard
                        .writeText(code)
                        .then(() => showFeedback(event.target));
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = code;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand("copy");
                        showFeedback(event.target);
                    } catch (err) {
                        console.error("Fallback: Oops, unable to copy", err);
                    }
                    document.body.removeChild(textArea);
                }
            }

            function showFeedback(button) {
                const originalText = button.textContent;
                button.textContent = "âœ… Copiado!";
                button.classList.add("bg-green-600");
                button.classList.remove("bg-[#0B5FFF]", "hover:bg-blue-700");
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove("bg-green-600");
                    button.classList.add("bg-[#0B5FFF]", "hover:bg-blue-700");
                }, 2000);
            }
        </script>
    </section>
</Layout>
